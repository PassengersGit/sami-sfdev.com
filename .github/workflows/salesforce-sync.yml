name: Sync PR to Salesforce

on:
  pull_request:
    types: [opened, closed, reopened]

jobs:
  sync-to-salesforce:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Get Salesforce Access Token
        id: sf-auth
        run: |
          response=$(curl -X POST https://login.salesforce.com/services/oauth2/token \
            -d "grant_type=password" \
            -d "client_id=${{ secrets.SF_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.SF_CLIENT_SECRET }}" \
            -d "username=${{ secrets.SF_USERNAME }}" \
            -d "password=${{ secrets.SF_PASSWORD }}${{ secrets.SF_SECURITY_TOKEN }}")
          
          access_token=$(echo $response | jq -r '.access_token')
          instance_url=$(echo $response | jq -r '.instance_url')
          
          echo "access_token=$access_token" >> $GITHUB_OUTPUT
          echo "instance_url=$instance_url" >> $GITHUB_OUTPUT
      
      - name: Create Salesforce Record
        run: |
          curl -X POST "${{ steps.sf-auth.outputs.instance_url }}/services/data/v59.0/sobjects/WebhookLog__c" \
            -H "Authorization: Bearer ${{ steps.sf-auth.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "Type__c": "pull_request",
              "Message__c": "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
            }'
